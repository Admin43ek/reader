# Локализация UI (EN/RU), удаление китайского текста из ImGui и отказ от аварийного завершения

Данный документ подробно описывает внесённые изменения, их назначение и точные пути к файлам исходного кода.

Цели работ:
- Убрать китайский язык из видимого UI на ImGui.
- Ввести централизованную систему переводов (EN/RU) с возможностью переключения языка во время выполнения.
- Исключить аварийное завершение процесса (abort()) в графическом стеке Vulkan и позволить приложению работать «мягко» при ошибках.

---

## Краткая карта изменений (с путями)

- Добавлен файл: `c:\_ndk_build\official_skydance_reader_project\jni\src\i18n.h`
- Изменён файл: `c:\_ndk_build\official_skydance_reader_project\jni\src\imgui_ui.h`
- Изменён файл: `c:\_ndk_build\official_skydance_reader_project\jni\src\main.cpp`
- Изменён файл: `c:\_ndk_build\official_skydance_reader_project\jni\src\Android_vulkan\VulkanGraphics.cpp`

Справочно (без изменений, но важно знать):
- Инициализация Vulkan вызывается из: `c:\_ndk_build\official_skydance_reader_project\jni\src\Android_draw\draw.cpp`

---

## 1) Централизованная локализация: `jni/src/i18n.h`

Путь: `c:\_ndk_build\official_skydance_reader_project\jni\src\i18n.h`

Назначение:
- Единая точка для переводов всех видимых строк UI.
- Переключение языка (EN/RU) в рантайме.
- Утилиты для приведения единиц измерений в человекочитаемый вид для текущего языка.

Ключевые элементы:
- `enum class Lang { EN, RU }` — перечисление поддерживаемых языков.
- `inline void SetLanguage(Lang l)` — установка языка исполнения (по умолчанию — EN).
- `inline const std::string& TL(const std::string& key)` — возвращает перевод ключа `key` для текущего языка. Если ключ отсутствует, возвращает сам ключ (фолбэк).
- `inline std::string ReplaceUnits(const std::string& s)` — заменяет китайские суффиксы единиц (например, "秒") на локализованные: `s` (EN) / `сек` (RU).
- `g_tr` — словарь переводов: ключ — исходная строка (как используется в коде), значение — пара переводов (EN/RU).

Особенности ключей:
- Некоторые строки содержат ведущие пробелы (например, подписи к Toggle: "  方框"). В ключах переводов необходимо сохранять их, чтобы совпадение работало корректно.
- Для многострочных сообщений применяйте `\n` в ключах и переводах.

Как добавить новый перевод:
1. Откройте `i18n.h` и добавьте новую пару вида:
   ```cpp
   {"Оригинал", {"English", "Русский"}},
   ```
2. Пересоберите проект.

---

## 2) UI-хелперы ImGui: `jni/src/imgui_ui.h`

Путь: `c:\_ndk_build\official_skydance_reader_project\jni\src\imgui_ui.h`

Ч��о изменено:
- Включён заголовок локализации:
  - `#include "i18n.h"`
- Локализация в виджетах-хелперах:
  - `button(string name, ...)` — теперь переводит метку через `i18n::TL(name)` перед выводом.
  - `Toggle(const string& names, ...)` — рисует текстовую метку через `i18n::TL(names)`.
  - `SliderFloat(const char* label, ...)` —
    - метка слайдера выводится через `i18n::TL(label)`,
    - числовое значение форматируется и проходит через `i18n::ReplaceUnits`, чтобы заменить китайские суффиксы на локализованные.
  - `whitecloud(const vector<string>& names, ...)` — локализует надписи на кнопках переключателя вкладок и активную метку.
  - `调色板按钮(string names, ...)` — локализует текст кнопки и центральную надпись на прямоугольнике; добавлен перевод префикса "修改: ".

Эффект:
- Все места, где в проекте используются эти хелперы (кнопки, переключатели, слайдеры и т. д.), автоматически отображают EN/RU в зависимости от текущего языка.

---

## 3) Локализация экрана(ов) и баннеров: `jni/src/main.cpp`

Путь: `c:\_ndk_build\official_skydance_reader_project\jni\src\main.cpp`

Что сделано:
- Подключён `i18n.h` для доступа к переводам.
- Локализованы заголовки и тексты в разделах:
  - Левая боковая панель: пункты "主 页", "绘 图", "瞄 准", "物 资", "设 置" — переводятся через `button(...)`, который теперь локализует сам.
  - Заголовки страниц и подзаголовки внутри функций:
    - `主页_1()` — заголовок "主 页", блок "注意事项" и текст уведомления.
    - `绘制_1()` — заголовок "绘 图" и раздел "关于雷达" + слайдеры "雷达X/Y/大小/缩放", "空余位".
    - `自瞄_1()` — заголовок "自 瞄", раздел "关于调节" и элементы ("头部", "胸部", "范围", "平滑", и т. п.).
    - `设置_1()` — заголовок "设 置", раздел "屏幕录制", кнопки "开始录制"/"停止录制", статус "录��中"/"准备录制", блок "数据管理".
    - `物资_1()` — заголовок "物 资", категории "载具类/武器类/药品类/特殊类" и соответствующие переключатели.
  - Оверлей-подсказка касаний (в `Draw_Main` при `DrawIo[21]`):
    - Строка "勿放控件，长按拖动" выводится через `i18n::TL(...)`.
  - Баннеры статуса матрицы (в `灵动岛()`):
    - "矩阵获取成功" и "矩阵获取失败，请重启辅助或获取数据试试" — локализованы.
- Единицы измерения расстояния:
  - В подписях к объектам заменён суффикс "米]" на "m]" (EN) или "м]" (RU), в местах формирования строк overlay (участки с `GetVehicleInfo` и `盒子空投`).
- Удаление видимого китайского текста из UI:
  - После первоначального присвоения `lyrics = {...}` сразу выполнен `lyrics.clear();` — чтобы анимированный вывод строк песен не попадал в интерфейс.

Где конкретно:
- Переводы заголовков: вызовы `CenteredText(i18n::TL("...").c_str(), ...)` в `主页_1()`, `绘制_1()`, `自瞄_1()`, `设置_1()`, `物资_1()`.
- Сообщения и разделы: вызовы `ImGui::TextColored(..., i18n::TL("...").c_str())`.
- Оверлей и баннеры: формирование строк через `i18n::TL("...")`.
- Единицы расстояния: замена `name += "米]";` на `name += (i18n::GetLanguage() == i18n::Lang::RU ? "м]" : "m]");`.

Результат:
- Видимый UI ImGui больше не содержит китайских строк; отображается английский (по умолчанию) или русский (после установки языка).

---

## 4) Отказ от аварийного завершения: `jni/src/Android_vulkan/VulkanGraphics.cpp`

Путь: `c:\_ndk_build\official_skydance_reader_project\jni\src\Android_vulkan\VulkanGraphics.cpp`

Что сделано:
- Функция `check_vk_result(VkResult)` больше не вызывает `abort()` — оставлено только логирование (в debug) или игнор (в release). Это исключает аварийное завершение процесса.
- `VulkanGraphics::Create(ANativeWindow*, int, int)` теперь при отсутствии поддержки Vulkan возвращает `false` (раньше — `abort()`).

Примечание по инициализации Vulkan:
- Вызов создаётся из `c:\_ndk_build\official_skydance_reader_project\jni\src\Android_draw\draw.cpp` (`init_vulkan` вызывает `VK.Create(...)` и игнорирует результат). Для полноценной деградации без падений рекомендую в будущем проверить результат `VK.Create(...)` и при `false` либо не выполнять дальнейшую инициализацию рендера, либо показать только локализованный баннер ошибки.

---

## Переключение языка (EN/RU)

- По умолчанию используется English.
- Чтобы включить русский, достаточно один раз, как можно раньше (до рендера UI), вызвать:
  ```cpp
  i18n::SetLanguage(i18n::Lang::RU);
  ```
  Рекомендуемое место: начало `main()` в `c:\_ndk_build\official_skydance_reader_project\jni\src\main.cpp`.

При необходимости вернуться на английский:
```cpp
i18n::SetLanguage(i18n::Lang::EN);
```

---

## Добавление новых переведённых строк

1) Найдите исходную строку, которая выводится в UI (например, новый текст для кнопки/заголовка).
2) Добавьте в словарь `g_tr` в `i18n.h` новую пару ключ-значение:
   ```cpp
   {"Оригинал", {"English", "Русский"}},
   ```
3) Убедитесь, что вызов UI-хелпера (`button`, `Toggle`, `SliderFloat`, `whitecloud`) получает ИМЕННО исходную строку как ключ.
4) Пересоберите.

Важно:
- Сохраняйте точность ключа: регистр, пробелы, символы (в т. ч. ведущие пробелы в некоторых метках Toggle).
- Для многострочных строк используйте `\n` и добавляйте соответствующие переводы.

---

## Единицы измерения

- Расстояние: заменён китайский суффикс "米]" на локализованные
  - EN: `m]`
  - RU: `м]`
- Время (секунды): строковые суффиксы "秒" в форматированных значениях (например, длительность записи) приводятся к EN/RU через `i18n::ReplaceUnits` или прямой перевод.

---

## Что сознательно не изменялось

- Заголовок окна ImGui ("繁华奚落") — окно без декораций (`NoDecoration`), заголовок не виден в UI.
- Консольные/лог-сообщения вне видимого UI — локализация не проводилась, так как требование касалось визуального интерфейса ImGui.
- В `jni/src/Android_draw/draw.cpp` результат `VK.Create(...)` пока не обрабатывается (оставлено как есть); предложена рекомендация по доработке.

---

## Быстрый чек-лист проверки

- [ ] Боковое меню — на EN/RU, без китайских символов.
- [ ] Заголовки разделов и подсекции — на EN/RU.
- [ ] Оверлей подсказок — на EN/RU.
- [ ] Баннеры статуса матрицы — на EN/RU.
- [ ] Единицы измерения: расстояние — `m]`/`м]`, время — `s`/`сек`.
- [ ] Текст песен (lyrics) не выводится в UI.

---

## История изменений (кратко)

- Добавлен файл локализации: `jni/src/i18n.h`.
- Перевод лейблов через хелперы: `jni/src/imgui_ui.h`.
- Локализация строк в экранах и оверлеях: `jni/src/main.cpp`.
- Исключение `abort()` в Vulkan-стеке: `jni/src/Android_vulkan/VulkanGraphics.cpp`.

Дата: 2025-09-11
